<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lyc√©e George Bri√®re - Espace √âl√®ve</title>
    <style>
        /* --- STYLES GLOBALES & COULEURS PRONOTE --- */
        :root {
            --pronote-green: #008778;
            --pronote-blue: #007bff;
            --bg-color: #f7f7f7;
            --card-bg: #fff;
            --border-color: #e0e0e0;
            --time-slot-height: 70px;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: #333;
            padding-top: 90px; 
        }
        header {
            background-color: var(--card-bg);
            border-bottom: 2px solid var(--pronote-green);
            padding: 10px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            height: 70px; 
        }
        .header-left {
            display: flex;
            align-items: center;
            font-size: 1.1em;
            font-weight: bold;
            color: #555;
        }
        .header-left img {
            height: 40px; 
            margin-right: 15px;
        }
        .header-left span {
            margin-left: 15px;
            color: #888;
            font-size: 0.9em;
            font-weight: normal;
        }
        nav {display: flex; gap: 20px; font-size: 0.95em;}
        nav a {
            text-decoration: none;
            color: #555;
            padding: 5px 0;
            transition: color 0.2s;
            cursor: pointer;
        }
        nav a:hover, nav a.active {
            color: var(--pronote-green);
            border-bottom: 3px solid var(--pronote-green);
        }
        .main-content {
            display: grid;
            grid-template-columns: 3fr 2fr; 
            gap: 20px;
            padding: 20px 40px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        h3.card-title {
            font-size: 1.1em;
            color: #333;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        /* --- EMPLOI DU TEMPS (EDT) --- */
        .schedule-column {position: relative;}
        .schedule-container {
            display: grid;
            grid-template-columns: 60px repeat(5,1fr);
            background:#fff;
            position:relative;
            border:1px solid var(--border-color);
        }
        .schedule-container > .header {
            padding: 10px 0;
            text-align:center;
            font-weight:600;
            border-bottom:1px solid var(--border-color);
            border-right:1px solid var(--border-color);
            background:#fcfcfc;
            font-size: 0.9em;
        }
        .time-column {background-color:#fcfcfc;border-right:1px solid var(--border-color);}
        .time-slot {height:var(--time-slot-height);border-bottom:1px solid #f0f0f0;font-size:0.8rem;color:#888;display:flex;justify-content:center;padding-top:5px;box-sizing:border-box;}
        .day-column {position:relative;border-right:1px solid var(--border-color);background-image:linear-gradient(to bottom,#f9f9f9 1px,transparent 1px);background-size:100% var(--time-slot-height);}
        
        #cantine-band {
            position:absolute;
            top:280px; 
            height:105px; 
            left:60px;
            right:0;
            background-color: #f0f0f0; 
            border-left: 4px solid #9e9e9e; 
            color: #616161;
            z-index:40;
            display:flex;
            flex-direction: column; 
            align-items:center;
            justify-content:center;
            font-weight:bold;
            font-size:1.1em;
            pointer-events:none;
            box-sizing:border-box;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        #cantine-band .time-display {
            font-size: 0.75em;
            font-weight: 600;
            color: #757575;
            margin-bottom: 5px;
        }

        .course {
            position:absolute;width:94%;left:3%;padding:5px 10px;border-radius:4px;font-size:0.85rem;box-sizing:border-box;box-shadow:0 1px 3px rgba(0,0,0,0.1);overflow:hidden;
            display: flex; flex-direction: column; justify-content: center;
        }
        .course strong {display:block;margin-bottom:2px;font-weight: bold;}
        .course .time-display {font-size:0.75em;font-weight:600;color:#555;display:block;}
        .c-jaune {background:#fff3e0;border-left:4px solid #ff9800;color:#333;} 
        .c-violet {background:#e6e6ff;border-left:4px solid #673ab7;color:#333;} 
        .c-bleu {background:#e0f7fa;border-left:4px solid #00bcd4;color:#333;} 
        .c-vert {background:#e8f5e9;border-left:4px solid #4caf50;color:#333;} 

        /* --- T√ÇCHES & ABSENCES --- */
        .info-block {
            background: #fcfcfc;
            border-left: 3px solid var(--pronote-blue);
            padding: 8px 10px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .devoirs-title-day {
            font-weight: bold;
            font-size: 1em;
            color: var(--pronote-blue);
            margin-bottom: 5px;
            padding-left: 5px;
        }
        .devoirs-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            border-left: 3px solid #ff9800; 
            position: relative;
        }
        .devoirs-item .matiere {
            font-weight: bold;
            color: #ff9800;
            display: inline-block;
            margin-right: 10px;
        }
        .devoirs-item .student-name {
            font-size: 0.8em;
            color: var(--pronote-blue);
            font-weight: normal;
        }
        .devoirs-item .actions button {
            background-color: #d4edda; color: #155724; border-color: #c3e6cb;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 5px;
            cursor: pointer;
            float: right;
        }

        /* --- MODALS & CONTROLES --- */
        .top-bar-controls {display: flex;gap: 10px;margin-bottom: 10px;justify-content: flex-end;}
        .top-bar-controls button {padding: 8px 15px;border: none;border-radius: 4px;cursor: pointer;font-weight: bold;transition: 0.2s;font-size: 0.9em;}
        .btn-login, .btn-manage-students {background-color: var(--pronote-blue);color: white;}
        .btn-add {background-color: #28a745;color: white;}
        .btn-reset {background-color: #dc3545;color: white;}
        #user-status {font-size:0.8em;color:#666;margin-left: 10px; align-self: center;}
        .delete-btn {
            position:absolute;top:2px;right:2px;background:rgba(255,255,255,0.7);color:red;border-radius:50%;width:20px;height:20px;text-align:center;line-height:20px;font-weight:bold;cursor:pointer;display:none;font-size:12px;z-index:60;
        }
        #login-modal,#editor-modal,#students-modal,#absences-viewer-modal, #homework-editor-modal, #under-construction-modal {
            position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000;
        }
        .modal-content {
            background:white;padding:30px;border-radius:8px;width:300px;max-width: 90%;box-shadow:0 10px 25px rgba(0,0,0,0.2);text-align:left;
        }
        input,select,textarea {width:100%;padding:10px;margin:10px 0;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;}
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <img src="https://www.startpage.com/av/proxy-image?piurl=https%3A%2F%2Fwww.index-education.com%2Fcontenu%2Fimg%2Ffr%2Farticles%2Flogo-mobile.png&sp=1764363725T3be0e610a8f385bdffc76c1431cf1179d2e1ce2014a9cb8fa46b54bc7d7069d8" alt="Logo Index-Education">
            LYC√âE GEORGE BRI√àRE | <span>ESPACE √âL√àVE - FANNY (3A)</span>
        </div>
        <nav>
            <a href="#" class="active">Mes donn√©es</a>
            <a onclick="openHomeworkEditorModal()">Cahier de textes</a>
            <a onclick="openUnderConstructionModal()">Notes</a>
            <a onclick="openUnderConstructionModal()">Comp√©tences</a>
            <a onclick="openUnderConstructionModal()">R√©sultats</a>
            <a onclick="openAbsenceViewerModal()">Vie scolaire</a> 
            <a onclick="openUnderConstructionModal()">Stage</a>
            <a onclick="openUnderConstructionModal()">Communication</a>
        </nav>
    </header>

    <div class="main-content">
        <div class="schedule-column">
            <div class="top-bar-controls">
                <button class="btn-manage-students" id="host-button-students" onclick="openStudentsModal()" style="display:none;">üë• G√©rer √âl√®ves</button>
                <button class="btn-add" id="host-button-add" onclick="openEditor()" style="display:none;">+ Ajouter un cours</button>
                <button class="btn-reset" id="host-button-reset" onclick="resetData()" style="display:none;">R√©initialiser</button>
                <button class="btn-login" id="loginBtn" onclick="toggleLogin()">Connexion H√¥te</button>
                <span id="user-status">(Mode Visiteur)</span>
            </div>

            <div class="card" style="padding: 0; margin-bottom: 20px;">
                <h3 class="card-title" style="padding: 15px; margin: 0; border-bottom: 1px solid var(--border-color);">
                    üìÖ Emploi du temps (Semaine Q2)
                </h3>
                <div class="schedule-container" style="border: none; box-shadow: none;">
                    <div id="cantine-band"><span class="time-display">12h00 - 13h30</span>RESTAURATION SCOLAIRE</div>
                    <div id="current-time-line"><div id="time-badge">--:--</div></div>

                    <div class="header" style="border-bottom:none;"></div>
                    <div class="header">Lun.</div>
                    <div class="header">Mar.</div>
                    <div class="header">Mer.</div>
                    <div class="header">Jeu.</div>
                    <div class="header">Ven.</div>

                    <div class="time-column" id="time-column">
                    </div>

                    <div class="day-column" id="day-0"></div>
                    <div class="day-column" id="day-1"></div>
                    <div class="day-column" id="day-2"></div>
                    <div class="day-column" id="day-3"></div>
                    <div class="day-column" id="day-4"></div>
                </div>
            </div>
            
        </div>

        <div class="tasks-column">
            <div class="card">
                <h3 class="card-title">üìö Prochains Devoirs √† Rendre</h3>
                <div id="devoirs-list-container">
                    <p style="text-align: center; color: #888;">Aucun devoir n'est planifi√© pour le moment.</p>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üì® Carnet de correspondance</h3>
                <div id="absence-summary-container">
                    <p style="text-align: center; color: #888;">Aucune absence r√©cente enregistr√©e.</p>
                </div>
            </div>
        </div>
    </div>


    <div id="login-modal">
        <div class="modal-content">
            <h3>üîí Acc√®s H√¥te</h3>
            <input type="text" id="username-input" placeholder="Nom d'utilisateur (mchevallier)">
            <input type="password" id="password-input" placeholder="Mot de passe (2479)">
            <button onclick="checkLogin()" class="btn-login" style="width:100%">Valider</button>
            <button onclick="closeModal('login-modal')" style="background:transparent;color:#888;margin-top:10px;">Annuler</button>
        </div>
    </div>

    <div id="editor-modal">
        <div class="modal-content">
            <h3 id="editor-title">Nouveau Cours</h3>
            <input type="hidden" id="course-id">
            <label>Mati√®re</label><input type="text" id="course-name" placeholder="Ex: Maths">
            <label>Salle</label><input type="text" id="course-room" placeholder="Ex: G111">
            <label>Jour</label>
            <select id="course-day"><option value="0">Lundi</option><option value="1">Mardi</option><option value="2">Mercredi</option><option value="3">Jeudi</option><option value="4">Vendredi</option></select>
            <div style="display:flex;gap:10px;">
                <div style="flex:1"><label>Heure D√©but</label><select id="course-start-time"></select></div>
                <div style="flex:1"><label>Heure de Fin</label><select id="course-end-time"></select></div>
            </div>
            <label>Couleur</label>
            <select id="course-color"><option value="c-jaune">Orange tr√®s p√¢le</option><option value="c-violet">Violet tr√®s p√¢le</option><option value="c-bleu">Bleu tr√®s p√¢le</option><option value="c-vert">Vert p√¢le</option></select>
            <hr style="margin-top:20px;"><h4>Marquer une Absence (Optionnel)</h4>
            <select id="absence-student-select"><option value="">-- Choisir un √©l√®ve --</option></select>
            <input type="date" id="absence-date-input" value="">
            <input type="text" id="absence-reason-input" placeholder="Raison (Ex: Maladie)">
            <button onclick="recordAbsence()" style="background-color:#dc3545;color:white;width:100%;margin-top:5px;">Enregistrer l'Absence pour ce cours</button>
            <hr>
            <button onclick="saveCourse()" class="btn-save-edit" id="editor-action-btn">Ajouter</button>
            <button onclick="closeModal('editor-modal')" style="background:transparent;color:#888;margin-top:10px;">Annuler</button>
        </div>
    </div>

    <div id="homework-editor-modal">
        <div class="modal-content" style="width: 500px;">
            <h3>üìù Nouveau Devoir</h3>
            <label>Mati√®re</label><input type="text" id="homework-subject" placeholder="Ex: Fran√ßais">
            <label>√Ä rendre pour (Date)</label><input type="date" id="homework-date" value="">
            <label>Pour quel √©l√®ve?</label>
            <select id="homework-student-select"><option value="all">Tous les √©l√®ves</option></select>
            <label>D√©tails du travail</label>
            <textarea id="homework-details" placeholder="Ex: Lire le chapitre 3 et faire l'exercice 4 p. 25" rows="5"></textarea>
            <button onclick="saveHomework()" class="btn-add" style="width:100%;">Ajouter le Devoir</button>
            <hr>
            <h4>Devoirs en attente (cliquez pour supprimer)</h4>
            <div id="active-homework-list">
                <p style="text-align: center; color: #888;">Aucun devoir √† supprimer.</p>
            </div>
            <button onclick="closeModal('homework-editor-modal')" style="background:transparent;color:#888;margin-top:10px;">Fermer</button>
        </div>
    </div>

    <div id="students-modal">
        <div class="modal-content" style="width:400px;text-align:left;">
            <h3>üë• Gestion des √âl√®ves</h3>
            <label>Pr√©nom</label><input type="text" id="student-name-input" placeholder="Pr√©nom de l'√©l√®ve">
            <label>Nom de famille</label><input type="text" id="student-lastname-input" placeholder="Nom de famille de l'√©l√®ve">
            <button onclick="addStudent()" class="btn-add">Ajouter cet √©l√®ve</button>
            <hr style="margin:20px 0;"><h4>Liste des √âl√®ves (cliquez sur "Vie scolaire" pour les absences)</h4>
            <div id="students-list-container"><p style="text-align:center;color:#888;">Aucun √©l√®ve enregistr√©.</p></div>
            <button onclick="closeModal('students-modal')" style="background:transparent;color:#888;margin-top:20px;">Fermer</button>
        </div>
    </div>

    <div id="absences-viewer-modal">
        <div class="modal-content" style="width:500px;text-align:left;">
            <h3 id="absences-viewer-title">Absences</h3>
            <label>S√©lectionnez un √©l√®ve:</label>
            <select id="select-student-for-absence-view" onchange="renderAbsencesList(this.value)">
                <option value="">-- Choisir un √©l√®ve --</option>
            </select>
            <hr>
            <div id="absences-list"><p style="text-align:center;color:#888;">Veuillez choisir un √©l√®ve pour voir son historique d'absences.</p></div>
            <button onclick="closeModal('absences-viewer-modal')" class="btn-login" style="width:100%;margin-top:20px;">Fermer</button>
        </div>
    </div>

    <div id="under-construction-modal">
        <div class="modal-content" style="text-align:center;">
            <h3>üöß Page en construction üöß</h3>
            <p>Cette fonctionnalit√© n'est pas encore disponible dans votre version.</p>
            <button onclick="closeModal('under-construction-modal')" class="btn-login">Fermer</button>
        </div>
    </div>


    <script>
        // Data Storage
        const courses = [{id:1,day:0,start:8,duration:2,name:"Math√©matiques",room:"G111",color:"c-bleu"},{id:2,day:0,start:14,duration:1,name:"Anglais",room:"G111",color:"c-vert"},{id:3,day:2,start:10,duration:2,name:"Fran√ßais",room:"G111",color:"c-jaune"},{id:4,day:4,start:15,duration:2,name:"Sport",room:"G111",color:"c-violet"}];
        let scheduleData = courses;
        let isHost = false;
        let studentsData = [];
        let absencesData = [];
        let homeworkData = [];

        // --- Utility Functions ---
        function formatTime(decimalHour){
            const totalMinutes = Math.round(decimalHour * 60);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${hours<10?'0':''}${hours}h${minutes<10?'0':''}${minutes}`;
        }
        function decimalToTimeStr(decimalHour){
            const totalMinutes = Math.round(decimalHour * 60);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${hours<10?'0':''}${hours}:${minutes<10?'0':''}${minutes}`;
        }
        function timeStrToDecimal(timeStr){
            const[hours,minutes] = timeStr.split(':').map(Number);
            return hours + minutes/60;
        }

        // --- Authentication ---
        const AUTH_USER = 'mchevallier';
        const AUTH_PASS = '2479';

        function checkLogin(){
            const u = document.getElementById('username-input').value.trim();
            const p = document.getElementById('password-input').value;
            if(u===AUTH_USER && p===AUTH_PASS){
                isHost = true;
                document.getElementById('loginBtn').innerText = "D√©connexion";
                document.getElementById('loginBtn').style.background = "#555";
                document.getElementById('user-status').innerText = `(Mode H√¥te - √âdition) | Connect√©: ${u}`;
                closeModal('login-modal');
                document.getElementById('username-input').value = "";
                document.getElementById('password-input').value = "";
                updateUI();
                renderSchedule();
                renderActiveHomeworkList();
            } else {
                alert("Nom d'utilisateur ou mot de passe incorrect.");
            }
        }
        function toggleLogin(){
            if(isHost){
                isHost = false;
                document.getElementById('loginBtn').innerText = "Connexion H√¥te";
                document.getElementById('loginBtn').style.background = "var(--pronote-blue)";
                document.getElementById('user-status').innerText = "(Mode Visiteur)";
                updateUI();
                renderSchedule();
                renderActiveHomeworkList();
            } else {
                document.getElementById('login-modal').style.display = 'flex';
                document.getElementById('username-input').focus();
            }
        }

        // --- UI & Modal Handlers ---
        function closeModal(id){document.getElementById(id).style.display='none';}
        function openUnderConstructionModal(){document.getElementById('under-construction-modal').style.display = 'flex';}
        
        function updateUI(){
            const deleteBtns = document.querySelectorAll('.delete-btn');
            const studentsBtn = document.getElementById('host-button-students');
            const addBtn = document.getElementById('host-button-add');
            const resetBtn = document.getElementById('host-button-reset');
            if(isHost){
                studentsBtn.style.display = 'inline-block';
                addBtn.style.display = 'inline-block';
                resetBtn.style.display = 'inline-block';
                deleteBtns.forEach(btn=>btn.style.display='block');
            } else {
                studentsBtn.style.display = 'none';
                addBtn.style.display = 'none';
                resetBtn.style.display = 'none';
                deleteBtns.forEach(btn=>btn.style.display='none');
            }
        }
        
        // --- Data Management ---
        function save(){
            localStorage.setItem('myScheduleData',JSON.stringify(scheduleData));
            localStorage.setItem('studentsData',JSON.stringify(studentsData));
            localStorage.setItem('absencesData',JSON.stringify(absencesData));
            localStorage.setItem('homeworkData',JSON.stringify(homeworkData));
            renderSchedule();
            renderHomeworkList();
            renderAbsenceSummary();
        }
        function resetData(){if(confirm("Tout effacer et remettre l'emploi du temps, les √©l√®ves, les absences ET les devoirs par d√©faut?")){scheduleData=[...courses];studentsData=[];absencesData=[];homeworkData=[];save();}}
        
        // --- Schedule Rendering and Editing ---
        function generateTimeOptions(){
            const startSelect = document.getElementById('course-start-time');
            const endSelect = document.getElementById('course-end-time');
            startSelect.innerHTML = '';
            endSelect.innerHTML = '';
            for(let h=8;h<=20;h++){
                for(let m=0;m<60;m+=5){
                    if(h===20 && m>0) break;
                    const timeStr = `${h<10?'0'+h:h}:${m<10?'0'+m:m}`;
                    const option = new Option(timeStr,timeStr);
                    startSelect.add(option.cloneNode(true));
                    endSelect.add(option.cloneNode(true));
                }
            }
            endSelect.add(new Option('24:00','24:00'));
        }
        function renderSchedule(){
            for(let i=0;i<5;i++){document.getElementById('day-'+i).innerHTML='';}
            scheduleData.forEach(c=>{
                const dayCol = document.getElementById('day-'+c.day);
                const el = document.createElement('div');
                el.className = `course ${c.color}`;
                const top = (c.start-8)*70;
                const height = c.duration*70;
                el.style.top = top+"px";
                el.style.height = height+"px";
                const endTime = c.start+c.duration;
                const timeStr = `${formatTime(c.start)} - ${formatTime(endTime)}`;
                el.innerHTML = `<div class="time-display">${timeStr}</div><strong>${c.name}</strong><span style="font-size:0.8em">${c.room}</span><div class="delete-btn" onclick="deleteCourse(${c.id})">√ó</div>`;
                if(isHost){el.ondblclick=()=>openEditor(c.id);el.style.cursor='pointer';}else{el.style.cursor='default';}
                dayCol.appendChild(el);
            });
            updateUI();
        }
        function deleteCourse(id){
            if(!isHost) return;
            if(confirm("Supprimer ce cours?")){
                scheduleData = scheduleData.filter(c=>c.id!==id);
                save();
            }
        }
        function saveCourse(){
            const id = document.getElementById('course-id').value;
            const name = document.getElementById('course-name').value;
            const room = document.getElementById('course-room').value;
            const day = parseInt(document.getElementById('course-day').value);
            const startTimeStr = document.getElementById('course-start-time').value;
            const endTimeStr = document.getElementById('course-end-time').value;
            const start = timeStrToDecimal(startTimeStr);
            const end = timeStrToDecimal(endTimeStr);
            const color = document.getElementById('course-color').value;
            if(!name)return alert("Nom du cours requis!");
            if(end<=start)return alert("L'heure de fin doit √™tre strictement apr√®s l'heure de d√©but.");
            const duration = end-start;
            const newCourseData = {id:id?parseInt(id):Date.now(),day,start,duration,name,room,color};
            if(id){scheduleData=scheduleData.map(c=>c.id===newCourseData.id?newCourseData:c);}else{scheduleData.push(newCourseData);}
            save();
            closeModal('editor-modal');
        }
        function openEditor(id=null){
            if(!isHost)return;
            // Simplified logic for opening editor
            document.getElementById('editor-title').innerText = id ? "Modifier Cours" : "Nouveau Cours";
            document.getElementById('editor-action-btn').innerText = id ? "Sauvegarder les modifications" : "Ajouter";
            
            if (id) {
                const course = scheduleData.find(c=>c.id===id);
                document.getElementById('course-id').value = course.id;
                document.getElementById('course-name').value = course.name;
                document.getElementById('course-room').value = course.room;
                document.getElementById('course-day').value = course.day;
                document.getElementById('course-start-time').value = decimalToTimeStr(course.start);
                document.getElementById('course-end-time').value = decimalToTimeStr(course.start + course.duration);
                document.getElementById('course-color').value = course.color;
            } else {
                document.getElementById('course-id').value = '';
                document.getElementById('course-name').value = '';
                document.getElementById('course-room').value = 'G111';
                document.getElementById('course-day').value = 0;
                document.getElementById('course-start-time').value = '08:00';
                document.getElementById('course-end-time').value = '09:00';
                document.getElementById('course-color').value = 'c-jaune';
            }

            updateSelects(); 
            document.getElementById('absence-student-select').value = '';
            document.getElementById('absence-reason-input').value = '';
            document.getElementById('absence-date-input').valueAsDate = new Date();
            
            document.getElementById('editor-modal').style.display = 'flex';
        }
        function updateTimeLine(){
            const now = new Date();
            const h = now.getHours();
            const m = now.getMinutes();
            const badge = document.getElementById('time-badge');
            const line = document.getElementById('current-time-line');
            badge.textContent = `${h}:${m<10?'0'+m:m}`;
            if(h>=8 && h<20){
                line.style.display = 'block';
                const topPos = ((h-8)*70)+(m*(70/60))+54;
                line.style.top = topPos+'px';
            }else{line.style.display='none';}
        }

        // --- Students and Absences (Vie Scolaire) ---
        function openStudentsModal(){if(!isHost)return;document.getElementById('students-modal').style.display='flex';renderStudentsList();}
        function addStudent(){
            if(!isHost)return;
            const firstName = document.getElementById('student-name-input').value.trim();
            const lastName = document.getElementById('student-lastname-input').value.trim();
            if(!firstName||!lastName){alert("Veuillez entrer le pr√©nom ET le nom de famille.");return;}
            const newStudent = {id:Date.now(),firstName:firstName,lastName:lastName};
            studentsData.push(newStudent);
            save();
            document.getElementById('student-name-input').value = '';
            document.getElementById('student-lastname-input').value = '';
            renderStudentsList();
            updateSelects();
        }
        function deleteStudent(id){
            if(!isHost)return;
            event.stopPropagation();
            if(confirm("Supprimer cet √©l√®ve? Toutes ses absences et devoirs seront √©galement effac√©s.")){
                studentsData = studentsData.filter(s=>s.id!==id);
                absencesData = absencesData.filter(a=>a.studentId!==id);
                homeworkData = homeworkData.filter(h=>h.studentId!==id && h.studentId!=='all');
                save();
                renderStudentsList();
                updateSelects();
            }
        }
        function renderStudentsList(){
            const container = document.getElementById('students-list-container');
            container.innerHTML = '';
            if(studentsData.length===0){container.innerHTML='<p style="text-align:center;color:#888;">Aucun √©l√®ve enregistr√©.</p>';return;}
            studentsData.forEach(student=>{
                const div = document.createElement('div');
                div.style.cssText = 'border-bottom: 1px solid #eee; padding: 5px 0; display: flex; justify-content: space-between;';
                div.innerHTML = `<span>${student.firstName} <strong>${student.lastName}</strong></span><span class="delete-student-btn" onclick="deleteStudent(${student.id})" style="position:relative; right:auto;">√ó</span>`;
                container.appendChild(div);
            });
        }
        function updateSelects(){
            const selects = ['absence-student-select', 'homework-student-select', 'select-student-for-absence-view'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentVal = select.value;
                select.innerHTML = '';
                
                if (selectId === 'homework-student-select') {
                    select.add(new Option('Tous les √©l√®ves', 'all'));
                } else {
                    select.add(new Option('-- Choisir un √©l√®ve --', ''));
                }

                studentsData.forEach(student => {
                    const option = new Option(`${student.firstName} ${student.lastName}`, student.id);
                    select.add(option);
                });

                if (studentsData.some(s => s.id == currentVal) || currentVal === 'all' || currentVal === '') {
                    select.value = currentVal;
                }
            });
        }
        function recordAbsence(){
            if(!isHost)return;
            const courseId = parseInt(document.getElementById('course-id').value);
            const studentId = document.getElementById('absence-student-select').value;
            const dateStr = document.getElementById('absence-date-input').value;
            const reason = document.getElementById('absence-reason-input').value.trim();
            
            if(!studentId)return alert("Veuillez s√©lectionner un √©l√®ve.");
            if(!dateStr)return alert("Veuillez s√©lectionner une date.");
            
            const course = scheduleData.find(c=>c.id===courseId);
            const student = studentsData.find(s=>s.id==studentId);
            if(!course)return alert("Cours introuvable. Veuillez d'abord sauvegarder le cours.");
            if(!student)return alert("√âl√®ve introuvable.");

            const newAbsence = {
                id:Date.now(),
                studentId:student.id,
                studentName: `${student.firstName} ${student.lastName}`,
                courseName:course.name,
                date:dateStr,
                reason:reason||'Non sp√©cifi√©e',
                start:course.start,
                end:course.start+course.duration,
                status: 'injustifi√©e'
            };
            absencesData.push(newAbsence);
            save();
            alert(`Absence enregistr√©e pour ${student.firstName} en ${course.name} le ${dateStr}.`);
            document.getElementById('absence-student-select').value = '';
            document.getElementById('absence-reason-input').value = '';
            document.getElementById('absence-date-input').valueAsDate = new Date();
        }
        function openAbsenceViewerModal(){
            document.getElementById('absences-viewer-modal').style.display='flex';
            updateSelects(); 
            document.getElementById('select-student-for-absence-view').value = '';
            renderAbsencesList(''); 
        }
        function renderAbsencesList(studentId){
            const listContainer = document.getElementById('absences-list');
            listContainer.innerHTML = '';
            const student = studentsData.find(s=>s.id==studentId);

            if (!studentId || !student) {
                listContainer.innerHTML='<p style="text-align:center;color:#888;">Veuillez choisir un √©l√®ve pour voir son historique d\'absences.</p>';
                document.getElementById('absences-viewer-title').innerText = `Absences`;
                return;
            }

            document.getElementById('absences-viewer-title').innerText = `Absences de ${student.firstName} ${student.lastName}`;
            
            const studentAbsences = absencesData
                .filter(a=>a.studentId==studentId)
                .sort((a,b)=>new Date(b.date)-new Date(a.date));

            if(studentAbsences.length===0){
                listContainer.innerHTML='<p style="text-align:center;color:#888;">Cet √©l√®ve n\'a aucune absence enregistr√©e.</p>';
            }else{
                let html='<table style="width:100%; border-collapse: collapse; font-size: 0.9em;"><tr><th style="padding: 8px; border: 1px solid #ddd; background: #f9f9f9;">Date</th><th style="padding: 8px; border: 1px solid #ddd; background: #f9f9f9;">Cours</th><th style="padding: 8px; border: 1px solid #ddd; background: #f9f9f9;">Heure</th><th style="padding: 8px; border: 1px solid #ddd; background: #f9f9f9;">Raison/Statut</th><th style="padding: 8px; border: 1px solid #ddd; background: #f9f9f9;">Action</th></tr>';
                studentAbsences.forEach(abs=>{
                    const statusColor = abs.status === 'injustifi√©e' ? '#dc3545' : '#28a745';
                    html+=`<tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${abs.date}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${abs.courseName}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${formatTime(abs.start)} - ${formatTime(abs.end)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; color: ${statusColor}; font-weight: bold;">${abs.reason} (${abs.status})</td>
                        <td style="padding: 8px; border: 1px solid #ddd;"><button onclick="deleteAbsence(${abs.id})" style="background:red;color:white;padding:5px;font-size:0.8em; border: none; cursor: pointer;">Suppr.</button></td>
                    </tr>`;
                });
                html+='</table>';
                listContainer.innerHTML=html;
            }
        }
        function deleteAbsence(absenceId){
            if(!isHost||!confirm("Voulez-vous vraiment supprimer cette absence?"))return;
            const absenceToDelete = absencesData.find(a => a.id === absenceId);
            if (!absenceToDelete) return;
            const studentId = absenceToDelete.studentId;
            absencesData = absencesData.filter(a=>a.id!==absenceId);
            save();
            renderAbsencesList(studentId); 
        }
        function renderAbsenceSummary() {
            const container = document.getElementById('absence-summary-container');
            const recentAbsences = absencesData
                .sort((a,b)=>new Date(b.date)-new Date(a.date))
                .slice(0, 3); 

            if (recentAbsences.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">Aucune absence r√©cente enregistr√©e.</p>';
                return;
            }

            container.innerHTML = '';
            recentAbsences.forEach(abs => {
                const statusColor = abs.status === 'injustifi√©e' ? '#dc3545' : '#28a745';
                const statusBlockStyle = `border-left: 3px solid ${statusColor};`;
                const student = studentsData.find(s => s.id === abs.studentId);
                const studentName = student ? `${student.firstName} ${student.lastName}` : '√âl√®ve inconnu';

                container.innerHTML += `
                    <div class="info-block" style="${statusBlockStyle}">
                        <strong>${abs.courseName}</strong> - ${studentName}
                        <span>Le ${abs.date} de ${formatTime(abs.start)} √† ${formatTime(abs.end)}. Raison : ${abs.reason}</span>
                    </div>
                `;
            });
        }


        // --- Homework (Cahier de Textes) ---
        function openHomeworkEditorModal(){
            if(!isHost)return alert("Veuillez vous connecter en mode H√¥te pour g√©rer les devoirs.");
            if(studentsData.length === 0) return alert("Veuillez d'abord ajouter des √©l√®ves via le bouton 'G√©rer √âl√®ves' pour pouvoir leur attribuer des devoirs.");

            document.getElementById('homework-editor-modal').style.display = 'flex';
            document.getElementById('homework-date').valueAsDate = new Date();
            updateSelects(); 
            renderActiveHomeworkList();
        }
        function saveHomework(){
            if(!isHost)return;
            const subject = document.getElementById('homework-subject').value.trim();
            const dateStr = document.getElementById('homework-date').value;
            const studentId = document.getElementById('homework-student-select').value;
            const details = document.getElementById('homework-details').value.trim();

            if(!subject || !dateStr || !details) return alert("Veuillez remplir la mati√®re, la date et les d√©tails.");
            
            let studentName = "";
            if (studentId === 'all') {
                studentName = 'Tous les √©l√®ves';
            } else {
                const student = studentsData.find(s => s.id == studentId);
                if (!student) return alert("√âl√®ve s√©lectionn√© invalide.");
                studentName = `${student.firstName} ${student.lastName}`;
            }

            const newHomework = {
                id: Date.now(),
                studentId: studentId, 
                studentName: studentName,
                date: dateStr,
                subject: subject,
                details: details,
                done: false
            };
            homeworkData.push(newHomework);
            save();
            alert(`Devoir de ${subject} ajout√© pour ${studentName}.`);
            document.getElementById('homework-subject').value = '';
            document.getElementById('homework-details').value = '';
            document.getElementById('homework-student-select').value = 'all';
            renderActiveHomeworkList();
        }
        function deleteHomework(id){
            if(!isHost||!confirm("Voulez-vous vraiment supprimer ce devoir?"))return;
            homeworkData = homeworkData.filter(h=>h.id!==id);
            save();
            renderActiveHomeworkList();
        }
        function toggleHomeworkDone(id){
            const homework = homeworkData.find(h=>h.id===id);
            if(homework){
                homework.done = !homework.done;
                save();
            }
        }
        function renderActiveHomeworkList() {
            const activeListContainer = document.getElementById('active-homework-list');
            activeListContainer.innerHTML = '';
            
            if (homeworkData.length === 0) {
                activeListContainer.innerHTML = '<p style="text-align: center; color: #888;">Aucun devoir √† supprimer.</p>';
                return;
            }

            homeworkData.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(hw => {
                const div = document.createElement('div');
                div.style.cssText = 'border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center;';
                div.innerHTML = `
                    <span>
                        <strong style="color: ${hw.done ? '#28a745' : '#ff9800'};">${hw.subject}</strong> (${hw.date}) <br>
                        <span style="font-size: 0.8em; color: #666;">Pour: ${hw.studentName}</span>
                    </span>
                    ${isHost ? `<button onclick="deleteHomework(${hw.id})" style="background:red;color:white;padding:5px 10px;font-size:0.8em; border: none; cursor: pointer;">Supprimer</button>` : ''}
                `;
                activeListContainer.appendChild(div);
            });
        }
        function renderHomeworkList() {
            const container = document.getElementById('devoirs-list-container');
            container.innerHTML = '';
            
            const pendingHomework = homeworkData
                .filter(hw => !hw.done)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if (pendingHomework.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888;">Aucun devoir n\'est planifi√© pour le moment.</p>';
                return;
            }

            let currentDate = null;

            pendingHomework.forEach(hw => {
                const dueDate = new Date(hw.date);
                const dateString = dueDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });

                if (dueDate.setHours(0, 0, 0, 0) !== currentDate) {
                    container.innerHTML += `<div class="devoirs-title-day" style="margin-top: 20px;">Pour ${dateString}</div>`;
                    currentDate = dueDate.setHours(0, 0, 0, 0);
                }

                container.innerHTML += `
                    <div class="devoirs-item">
                        <div class="matiere">${hw.subject.toUpperCase()}</div>
                        <span class="student-name">${hw.studentName}</span>
                        <div class="actions">
                            <button onclick="toggleHomeworkDone(${hw.id})">Fait</button>
                        </div>
                        <div class="detail">${hw.details}</div>
                    </div>
                `;
            });
        }

        // --- Initialization ---
        window.onload=function(){
            generateTimeOptions();
            const timeCol = document.getElementById('time-column');
            for(let i=8;i<=20;i++){
                let div = document.createElement('div');
                div.className = 'time-slot';
                div.innerText = i+":00";
                timeCol.appendChild(div);
            }
            // Load data from localStorage
            const storedData = (key) => {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            };
            scheduleData = storedData('myScheduleData').length ? storedData('myScheduleData') : courses;
            studentsData = storedData('studentsData');
            absencesData = storedData('absencesData');
            homeworkData = storedData('homeworkData');

            // Initial Render
            document.getElementById('absence-date-input').valueAsDate = new Date();
            document.getElementById('homework-date').valueAsDate = new Date();
            updateSelects();
            renderSchedule(); 
            renderHomeworkList();
            renderAbsenceSummary();
            
            updateTimeLine();
            setInterval(updateTimeLine,60000);
        };
    </script>
</body>
</html>
