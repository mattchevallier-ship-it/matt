<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESPACE √âL√àVE - Emploi du Temps</title>
    <style>
        /* --- NOUVEAUX STYLES PRONOTE --- */
        :root {
            --pronote-green: #008778;
            --pronote-blue: #007bff;
            --bg-color: #f7f7f7;
            --card-bg: #fff;
            --border-color: #e0e0e0;
            --time-slot-height: 70px;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: #333;
        }
        header {
            background-color: var(--card-bg);
            border-bottom: 2px solid var(--pronote-green);
            padding: 10px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .header-left {
            display: flex;
            align-items: center;
            font-size: 1.1em;
            font-weight: bold;
            color: #555;
        }
        .header-left span {
            margin-left: 15px;
            color: var(--pronote-green);
        }
        nav {
            display: flex;
            gap: 20px;
            font-size: 0.95em;
        }
        nav a {
            text-decoration: none;
            color: #555;
            padding: 5px 0;
            transition: color 0.2s;
        }
        nav a:hover, nav a.active {
            color: var(--pronote-green);
            border-bottom: 3px solid var(--pronote-green);
        }
        .main-content {
            display: grid;
            grid-template-columns: 3fr 2fr 1fr; /* EDTs, T√¢ches, Agenda */
            gap: 20px;
            padding: 20px 40px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        h3.card-title {
            font-size: 1.1em;
            color: #333;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 15px;
        }
        /* Style pour les blocs d'informations (similaire √† "Absence justifi√©e") */
        .info-block {
            background: #fcfcfc;
            border-left: 3px solid var(--pronote-blue);
            padding: 8px 10px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .info-block strong {
            color: #333;
            font-weight: bold;
        }
        .info-block span {
            color: #666;
            display: block;
            margin-top: 2px;
        }

        /* --- EMPLOI DU TEMPS (Adapt√© au nouveau th√®me) --- */
        .schedule-container {
            grid-column: 1 / 2; /* Prend la premi√®re colonne */
            display: grid;
            grid-template-columns: 60px repeat(5,1fr);
            background:#fff;
            border-radius:4px;
            box-shadow:0 4px 12px rgba(0,0,0,0.05);
            position:relative;
            border:1px solid var(--border-color);
            margin-top: 0;
        }
        .schedule-container > .header {
            padding: 10px 0;
            text-align:center;
            font-weight:600;
            border-bottom:1px solid var(--border-color);
            border-right:1px solid var(--border-color);
            background:#fcfcfc;
            font-size: 0.9em;
        }
        .time-column {background-color:#fcfcfc;border-right:1px solid var(--border-color);}
        .time-slot {height:var(--time-slot-height);border-bottom:1px solid #f0f0f0;font-size:0.8rem;color:#888;display:flex;justify-content:center;padding-top:5px;box-sizing:border-box;}
        .day-column {position:relative;border-right:1px solid var(--border-color);background-image:linear-gradient(to bottom,#f9f9f9 1px,transparent 1px);background-size:100% var(--time-slot-height);}
        #cantine-band {position:absolute;top:369px;height:105px;left:60px;right:0;background-color:#e6ffeb;border:1px solid #4caf50;border-width:1px 0;z-index:40;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:1.4em;color:#388e3c;pointer-events:none;box-sizing:border-box;}
        .course {
            position:absolute;width:94%;left:3%;padding:5px 10px;border-radius:4px;font-size:0.85rem;box-sizing:border-box;box-shadow:0 1px 3px rgba(0,0,0,0.1);overflow:hidden;
            display: flex; flex-direction: column; justify-content: center;
        }
        .course strong {display:block;margin-bottom:2px;font-weight: bold;}
        .course .time-display {font-size:0.75em;font-weight:600;color:#555;display:block;}
        .c-jaune {background:#fff3e0;border-left:4px solid #ff9800;color:#333;} /* Orange pronote */
        .c-violet {background:#e6e6ff;border-left:4px solid #673ab7;color:#333;} /* Violet */
        .c-bleu {background:#e0f7fa;border-left:4px solid #00bcd4;color:#333;} /* Bleu ciel pronote */
        .c-vert {background:#e8f5e9;border-left:4px solid #4caf50;color:#333;} /* Vert clair pronote */

        /* --- Devoirs √† faire (Dans le bloc central) --- */
        .homework-container {
            border: none;
            box-shadow: none;
            padding: 0;
            display: block;
        }
        .devoirs-title-day {
            font-weight: bold;
            font-size: 1em;
            color: var(--pronote-blue);
            margin-bottom: 5px;
            padding-left: 5px;
        }
        .devoirs-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            border-left: 3px solid #ff9800; /* Orange pour travail */
        }
        .devoirs-item .matiere {
            font-weight: bold;
            color: #ff9800;
            display: inline-block;
            margin-right: 10px;
        }
        .devoirs-item .detail {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        .devoirs-item button {
            background-color: #f0f0f0;
            color: #555;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 0.8em;
            float: right;
        }

        /* --- Agenda (Bloc de droite) --- */
        .agenda-item {
            font-size: 0.9em;
            margin-bottom: 10px;
            border-left: 3px solid var(--pronote-green);
            padding-left: 8px;
            line-height: 1.4;
        }
        .agenda-item .date {
            font-weight: bold;
            color: var(--pronote-green);
            margin-right: 5px;
        }
        .agenda-item .title {
            color: #333;
        }

        /* --- Boutons et Modals (Garde la fonctionnalit√© compact√©e) --- */
        .top-bar-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .top-bar-controls button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            font-size: 0.9em;
        }
        .btn-login, .btn-manage-students {background-color: var(--pronote-blue);color: white;}
        .btn-add {background-color: #28a745;color: white;}
        .btn-reset {background-color: #dc3545;color: white;}
        #user-status {font-size:0.8em;color:#666;margin-left: 10px;}
        .delete-btn {
            position:absolute;top:2px;right:2px;background:rgba(255,255,255,0.7);color:red;border-radius:50%;width:20px;height:20px;text-align:center;line-height:20px;font-weight:bold;cursor:pointer;display:none;font-size:12px;z-index:60;
        }
        #login-modal,#editor-modal,#students-modal,#absences-viewer-modal {
            position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000;
        }
        .modal-content {
            background:white;padding:30px;border-radius:8px;width:300px;box-shadow:0 10px 25px rgba(0,0,0,0.2);text-align:left; /* Alignement √† gauche pour les formulaires */
        }
        input,select {width:100%;padding:10px;margin:10px 0;border:1px solid #ddd;border-radius:4px;box-sizing:border-box;}
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <img src="https://static.wixstatic.com/media/7e3b12_141a067087b34b159f37c376ef957388~mv2.png" alt="Logo Pronote" style="height: 30px; margin-right: 10px;">
            SITE DE D√âMONSTRATION | <span style="font-size:0.9em;">ESPACE √âL√àVE - FANNY (3A)</span>
        </div>
        <nav>
            <a href="#" class="active">Mes donn√©es</a>
            <a href="#">Cahier de textes</a>
            <a href="#">Notes</a>
            <a href="#">Comp√©tences</a>
            <a href="#">R√©sultats</a>
            <a href="#">Vie scolaire</a>
            <a href="#">Stage</a>
            <a href="#">Communication</a>
        </nav>
    </header>

    <div class="main-content">
        <div class="schedule-column">
            <div class="top-bar-controls">
                <button class="btn-manage-students" id="host-button-students" onclick="openStudentsModal()" style="display:none;">üë• G√©rer √âl√®ves</button>
                <button class="btn-add" id="host-button-add" onclick="openEditor()" style="display:none;">+ Ajouter un cours</button>
                <button class="btn-reset" id="host-button-reset" onclick="resetData()" style="display:none;">R√©initialiser</button>
                <button class="btn-login" id="loginBtn" onclick="toggleLogin()">Connexion H√¥te</button>
                <span id="user-status">(Mode Visiteur)</span>
            </div>

            <div class="card" style="padding: 0; margin-bottom: 20px;">
                <h3 class="card-title" style="padding: 15px; margin: 0; border-bottom: 1px solid var(--border-color);">
                    üìÖ Emploi du temps (Semaine Q2)
                </h3>
                <div class="schedule-container" style="border: none; box-shadow: none;">
                    <div id="cantine-band">CANTINE</div>
                    <div id="current-time-line"><div id="time-badge">--:--</div></div>

                    <div class="header" style="border-bottom:none;"></div>
                    <div class="header">Lun.</div>
                    <div class="header">Mar.</div>
                    <div class="header">Mer.</div>
                    <div class="header">Jeu.</div>
                    <div class="header">Ven.</div>

                    <div class="time-column" id="time-column">
                    </div>

                    <div class="day-column" id="day-0"></div>
                    <div class="day-column" id="day-1"></div>
                    <div class="day-column" id="day-2"></div>
                    <div class="day-column" id="day-3"></div>
                    <div class="day-column" id="day-4"></div>
                </div>
            </div>
            
            <div class="card homework-container">
                <h3 class="card-title">üìñ Devoirs √† Rendre (R√©p√©titifs)</h3>
                <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;">
                    <div class="devoirs-item" style="border-left-color:#007bff;"><div class="matiere" style="color:#007bff;">Lundi</div>|Maths|</div>
                    <div class="devoirs-item" style="border-left-color:#007bff;"><div class="matiere" style="color:#007bff;">Mardi</div>|Histoire/SVT|</div>
                    <div class="devoirs-item" style="border-left-color:#007bff;"><div class="matiere" style="color:#007bff;">Mercredi</div>|SES/LVB|</div>
                    <div class="devoirs-item" style="border-left-color:#007bff;"><div class="matiere" style="color:#007bff;">Jeudi</div>|Physique/SNT|</div>
                    <div class="devoirs-item" style="border-left-color:#007bff;"><div class="matiere" style="color:#007bff;">Vendredi</div>|FR/ANG|</div>
                </div>
            </div>
        </div>

        <div class="tasks-column">
            <div class="card">
                <h3 class="card-title">üìö Prochains Devoirs</h3>
                <div class="devoirs-title-day">Pour lundi 23 juil.</div>
                <div class="devoirs-item">
                    <div class="matiere">MATH√âMATIQUES</div>
                    <button>Non Fait</button>
                    <div class="detail">Exercices n¬∞5, 6 et 7 p.43</div>
                </div>
                <div class="devoirs-title-day">Pour mardi 24 juil.</div>
                <div class="devoirs-item">
                    <div class="matiere">ANGLAIS LV1</div>
                    <button>Non Fait</button>
                    <div class="detail">R√©daction: raconter en 300 mots une anecdote de vos vacances</div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üì® Carnet de correspondance</h3>
                <div class="info-block">
                    <strong>Absence justifi√©e</strong>
                    <span>du 12 avril √† 8h00 au 18 mai √† 18h00</span>
                </div>
                <div class="info-block" style="border-left-color:#dc3545;">
                    <strong>Absence injustifi√©e</strong>
                    <span>du 27 avr. √† 8h00 au 4 mai √† 8h30</span>
                </div>
                <div class="info-block">
                    <strong>Absence justifi√©e</strong>
                    <span>du 14 avr. √† 8h00 au 20 avr. √† 18h00</span>
                </div>
            </div>
        </div>

        <div class="info-column">
            <div class="card">
                <h3 class="card-title">üîó Liens et num√©ros utiles</h3>
                <ul style="list-style: none; padding: 0; font-size: 0.9em;">
                    <li style="margin-bottom: 5px;"><a href="#" style="color:var(--pronote-blue);">‚Ä¢ Protocole sanitaire</a></li>
                    <li style="margin-bottom: 5px;"><a href="#" style="color:var(--pronote-blue);">‚Ä¢ Les √©co-d√©l√©gu√©s, c'est quoi ?</a></li>
                    <li style="margin-bottom: 5px;"><a href="#" style="color:var(--pronote-blue);">‚Ä¢ Pass'Sport : 50 euros pour faire du sport</a></li>
                </ul>
            </div>

            <div class="card">
                <h3 class="card-title">üóìÔ∏è Agenda</h3>
                <div class="agenda-item">
                    <span class="date">18 juil.</span> Inscription au groupe d'activit√©
                </div>
                <div class="agenda-item">
                    <span class="date">29 juil.</span> √âlection des d√©l√©gu√©s de classe
                </div>
                <div class="agenda-item">
                    <span class="date">05 ao√ªt.</span> Chorale Gospel
                </div>
            </div>
        </div>
    </div>


    <div id="login-modal">
        <div class="modal-content" id="login-form-content">
            <h3>üîí Acc√®s H√¥te</h3>
            <input type="text" id="username-input" placeholder="Nom d'utilisateur">
            <input type="password" id="password-input" placeholder="Mot de passe">
            <button onclick="checkLogin()" class="btn-login" style="width:100%">Valider</button>
            <button onclick="closeModal('login-modal')" style="background:transparent;color:#888;margin-top:10px;">Annuler</button>
        </div>
    </div>

    <div id="editor-modal">
        <div class="modal-content" id="editor-form-content">
            <h3 id="editor-title">Nouveau Cours</h3>
            <input type="hidden" id="course-id">
            <label>Mati√®re</label><input type="text" id="course-name" placeholder="Ex: Maths">
            <label>Salle</label><input type="text" id="course-room" placeholder="Ex: G111">
            <label>Jour</label>
            <select id="course-day"><option value="0">Lundi</option><option value="1">Mardi</option><option value="2">Mercredi</option><option value="3">Jeudi</option><option value="4">Vendredi</option></select>
            <div style="display:flex;gap:10px;">
                <div style="flex:1"><label>Heure D√©but</label><select id="course-start-time"></select></div>
                <div style="flex:1"><label>Heure de Fin</label><select id="course-end-time"></select></div>
            </div>
            <label>Couleur</label>
            <select id="course-color"><option value="c-jaune">Orange tr√®s p√¢le</option><option value="c-violet">Violet tr√®s p√¢le</option><option value="c-bleu">Bleu tr√®s p√¢le</option><option value="c-vert">Vert p√¢le</option></select>
            <hr style="margin-top:20px;"><h4>Marquer une Absence (Optionnel)</h4>
            <select id="absence-student-select"><option value="">-- Choisir un √©l√®ve --</option></select>
            <input type="date" id="absence-date-input" value="">
            <input type="text" id="absence-reason-input" placeholder="Raison (Ex: Maladie)">
            <button onclick="recordAbsence()" style="background-color:#dc3545;color:white;width:100%;margin-top:5px;">Enregistrer l'Absence pour ce cours</button>
            <hr>
            <button onclick="saveCourse()" class="btn-save-edit" id="editor-action-btn">Ajouter</button>
            <button onclick="closeModal('editor-modal')" style="background:transparent;color:#888;margin-top:10px;">Annuler</button>
        </div>
    </div>

    <div id="students-modal">
        <div class="modal-content" style="width:400px;text-align:left;">
            <h3>üë• Gestion des √âl√®ves</h3>
            <label>Pr√©nom</label><input type="text" id="student-name-input" placeholder="Pr√©nom de l'√©l√®ve">
            <label>Nom de famille</label><input type="text" id="student-lastname-input" placeholder="Nom de famille de l'√©l√®ve">
            <button onclick="addStudent()" class="btn-save-edit" style="background-color:#28a745;">Ajouter cet √©l√®ve</button>
            <hr style="margin:20px 0;"><h4>Liste des √âl√®ves (cliquez pour voir les absences)</h4>
            <div id="students-list-container"><p style="text-align:center;color:#888;">Aucun √©l√®ve enregistr√©.</p></div>
            <button onclick="closeModal('students-modal')" style="background:transparent;color:#888;margin-top:20px;">Fermer</button>
        </div>
    </div>

    <div id="absences-viewer-modal">
        <div class="modal-content" style="width:500px;text-align:left;">
            <h3 id="absences-viewer-title">Absences de [√âl√®ve]</h3>
            <div id="absences-list"><p style="text-align:center;color:#888;">Cet √©l√®ve n'a aucune absence enregistr√©e.</p></div>
            <button onclick="closeModal('absences-viewer-modal')" class="btn-login" style="width:100%;margin-top:20px;">Fermer</button>
        </div>
    </div>


    <script>
        const courses = [{id:1,day:0,start:8,duration:2,name:"Math√©matiques",room:"G111",color:"c-bleu"},{id:2,day:0,start:14,duration:1,name:"Anglais",room:"G111",color:"c-vert"},{id:3,day:2,start:10,duration:2,name:"Fran√ßais",room:"G111",color:"c-jaune"},{id:4,day:4,start:15,duration:2,name:"Sport",room:"G111",color:"c-violet"}];
        let scheduleData = courses;
        let isHost = false;
        let currentEditingId = null;

        // --- Variables Leurre Alpha Globales (Obfuscation maintenue) ---
        const ALPHA_X='X';const BETA_Z='Z';const GAMMA_Q='Q';const DELTA_W='W';const EPS_F='F';const ZETA_J='J';const ETA_K='K';const THETA_L='L';const IOTA_P='P';const KAP_Y='Y';const LAMB_A='A';const MU_S='S';
        let studentsData = [];
        let absencesData = [];

        function deleteCourse(id){
            if(!isHost) return;
            if(confirm("Supprimer ce cours?")){
                scheduleData = scheduleData.filter(c=>c.id!==id);
                save();
            }
        }

        // --- Variables Leurre Num√©riques Globales (Obfuscation maintenue) ---
        const BASE_N_987=987.65;const CONST_42=42;const TINY_001=0.01;const CONST_15=15;const PI_APPROX=3.14159;const HUNDRED=100;const NINETEEN=19;

        function getAuthData(){
            // Calculs pour le mot de passe (2479)
            const CALC_P2 = Math.round(Math.sqrt(HUNDRED / 25));
            const NOISE_1A = (NINETEEN + CONST_42) * TINY_001;
            const CALC_P4 = Math.round((CONST_42 / 10.5));
            const NOISE_2B = PI_APPROX * HUNDRED;
            const CALC_P7 = Math.round(Math.pow(2, 3) - 1);
            const NOISE_3C = BASE_N_987 / CONST_15;
            const CALC_P9 = Math.round(CONST_15 * 0.6);
            const PW = CALC_P2.toString() + CALC_P4.toString() + CALC_P7.toString() + CALC_P9.toString();

            // Calculs pour le Nom d'utilisateur (mchevallier)
            const NOISE_4D = CONST_42 + NINETEEN;
            const FRAG_M_BASE = HUNDRED + 9;
            const FRAG_M = String.fromCharCode(FRAG_M_BASE + (CONST_15 * 0.0) + (NINETEEN - 19));
            const DECOY_COMBINE = ALPHA_X + BETA_Z + GAMMA_Q;
            const FRAG_C = String.fromCharCode(HUNDRED - 1);
            const DECOY_MULT = BASE_N_987 * TINY_001;
            const FRAG_H = String.fromCharCode(HUNDRED + CONST_42 / 7 - 2);
            const DECOY_COMBINE2 = DELTA_W + EPS_F;
            const FRAG_E1 = String.fromCharCode(HUNDRED + 1);
            const DECOY_SUM = BASE_N_987 + CONST_42 + TINY_001;
            const FRAG_V = String.fromCharCode(HUNDRED + 18);
            const DECOY_COMBINE3 = ZETA_J + ETA_K + THETA_L;
            const FRAG_A = String.fromCharCode(HUNDRED - 3);
            const DECOY_PROD_N = CONST_15 * NINETEEN;
            const FRAG_L1 = String.fromCharCode(Math.round(HUNDRED + 8));
            const DECOY_COMBINE4 = IOTA_P + KAP_Y;
            const FRAG_L2 = FRAG_L1;
            const DECOY_SUM2 = BASE_N_987 + NINETEEN;
            const FRAG_I = String.fromCharCode(Math.round(HUNDRED + 5));
            const DECOY_COMBINE5 = LAMB_A + MU_S;
            const FRAG_E2 = FRAG_E1;
            const FRAG_R = String.fromCharCode(HUNDRED + 14);
            const UN = FRAG_M + FRAG_C + FRAG_H + FRAG_E1 + FRAG_V + FRAG_A + FRAG_L1 + FRAG_L2 + FRAG_I + FRAG_E2 + FRAG_R;
            return {UN, PW};
        }

        function checkLogin(){
            const u = document.getElementById('username-input').value.trim();
            const p = document.getElementById('password-input').value;
            const auth = getAuthData();
            if(u===auth.UN && p===auth.PW){
                isHost = true;
                document.getElementById('loginBtn').innerText = "D√©connexion";
                document.getElementById('loginBtn').style.background = "#555";
                document.getElementById('user-status').innerText = `(Mode H√¥te - √âdition) | Connect√©: ${u}`;
                document.getElementById('username-input').value = "";
                document.getElementById('password-input').value = "";
                closeModal('login-modal');
                updateUI();
                renderSchedule();
            } else {
                alert("Nom d'utilisateur ou mot de passe incorrect.");
            }
        }

        function formatTime(decimalHour){
            const totalMinutes = Math.round(decimalHour * 60);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${hours<10?'0':''}${hours}h${minutes<10?'0':''}${minutes}`;
        }
        function decimalToTimeStr(decimalHour){
            const totalMinutes = Math.round(decimalHour * 60);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${hours<10?'0':''}${hours}:${minutes<10?'0':''}${minutes}`;
        }
        function timeStrToDecimal(timeStr){
            const[hours,minutes] = timeStr.split(':').map(Number);
            return hours + minutes/60;
        }
        function generateTimeOptions(){
            const startSelect = document.getElementById('course-start-time');
            const endSelect = document.getElementById('course-end-time');
            startSelect.innerHTML = '';
            endSelect.innerHTML = '';
            for(let h=8;h<=20;h++){
                for(let m=0;m<60;m+=5){
                    if(h===20 && m>0) break;
                    const timeStr = `${h<10?'0'+h:h}:${m<10?'0'+m:m}`;
                    const option = new Option(timeStr,timeStr);
                    startSelect.add(option.cloneNode(true));
                    endSelect.add(option.cloneNode(true));
                }
            }
            endSelect.add(new Option('24:00','24:00'));
        }
        window.onload=function(){
            generateTimeOptions();
            const timeCol = document.getElementById('time-column');
            for(let i=8;i<=20;i++){
                let div = document.createElement('div');
                div.className = 'time-slot';
                div.innerText = i+":00";
                timeCol.appendChild(div);
            }
            const storedSchedule = localStorage.getItem('myScheduleData');
            if(storedSchedule) scheduleData = JSON.parse(storedSchedule);
            const storedStudents = localStorage.getItem('studentsData');
            if(storedStudents) studentsData = JSON.parse(storedStudents);
            const storedAbsences = localStorage.getItem('absencesData');
            if(storedAbsences) absencesData = JSON.parse(storedAbsences);
            document.getElementById('absence-date-input').valueAsDate = new Date();
            const loginModalContent = document.getElementById('login-modal');
            loginModalContent.addEventListener('keydown',function(event){if(event.key==='Enter'){event.preventDefault();checkLogin();}});
            const editorModalContent = document.getElementById('editor-modal');
            editorModalContent.addEventListener('keydown',function(event){if(event.key==='Enter' && event.target.tagName!=='BUTTON' && event.target.tagName!=='SELECT'){event.preventDefault();saveCourse();}});
            
            renderSchedule(); 
            
            updateTimeLine();
            setInterval(updateTimeLine,60000);
        };
        function updateAbsenceStudentSelect(){
            const select = document.getElementById('absence-student-select');
            const currentSelectedId = select.value;
            select.innerHTML = '<option value="">-- Choisir un √©l√®ve --</option>';
            studentsData.forEach(student=>{const option=new Option(`${student.firstName} ${student.lastName}`,student.id);select.add(option);});
            if(currentSelectedId && studentsData.some(s=>s.id==currentSelectedId)){select.value=currentSelectedId;}
        }
        function toggleLogin(){
            if(isHost){
                isHost = false;
                document.getElementById('loginBtn').innerText = "Connexion H√¥te";
                document.getElementById('loginBtn').style.background = "var(--pronote-blue)";
                document.getElementById('user-status').innerText = "(Mode Visiteur)";
                updateUI();
                renderSchedule();
            } else {
                document.getElementById('login-modal').style.display = 'flex';
                document.getElementById('username-input').focus();
            }
        }
        function updateUI(){
            const deleteBtns = document.querySelectorAll('.delete-btn');
            const studentsBtn = document.getElementById('host-button-students');
            const addBtn = document.getElementById('host-button-add');
            const resetBtn = document.getElementById('host-button-reset');
            if(isHost){
                studentsBtn.style.display = 'inline-block';
                addBtn.style.display = 'inline-block';
                resetBtn.style.display = 'inline-block';
                deleteBtns.forEach(btn=>btn.style.display='block');
            } else {
                studentsBtn.style.display = 'none';
                addBtn.style.display = 'none';
                resetBtn.style.display = 'none';
                deleteBtns.forEach(btn=>btn.style.display='none');
            }
        }
        function save(){
            localStorage.setItem('myScheduleData',JSON.stringify(scheduleData));
            localStorage.setItem('studentsData',JSON.stringify(studentsData));
            localStorage.setItem('absencesData',JSON.stringify(absencesData));
            renderSchedule();
        }
        function renderSchedule(){
            for(let i=0;i<5;i++){document.getElementById('day-'+i).innerHTML='';}
            scheduleData.forEach(c=>{
                const dayCol = document.getElementById('day-'+c.day);
                const el = document.createElement('div');
                el.className = `course ${c.color}`;
                const top = (c.start-8)*70;
                const height = c.duration*70;
                el.style.top = top+"px";
                el.style.height = height+"px";
                const endTime = c.start+c.duration;
                const timeStr = `${formatTime(c.start)} - ${formatTime(endTime)}`;
                el.innerHTML = `<div class="time-display">${timeStr}</div><strong>${c.name}</strong><span style="font-size:0.8em">${c.room}</span><div class="delete-btn" onclick="deleteCourse(${c.id})">√ó</div>`;
                if(isHost){el.ondblclick=()=>openEditor(c.id);el.style.cursor='pointer';}else{el.style.cursor='default';}
                dayCol.appendChild(el);
            });
            updateUI();
        }
        function openStudentsModal(){if(!isHost)return;document.getElementById('students-modal').style.display='flex';renderStudentsList();}
        function addStudent(){
            if(!isHost)return;
            const firstName = document.getElementById('student-name-input').value.trim();
            const lastName = document.getElementById('student-lastname-input').value.trim();
            if(!firstName||!lastName){alert("Veuillez entrer le pr√©nom ET le nom de famille.");return;}
            const newStudent = {id:Date.now(),firstName:firstName,lastName:lastName};
            studentsData.push(newStudent);
            saveStudentsData();
            document.getElementById('student-name-input').value = '';
            document.getElementById('student-lastname-input').value = '';
            renderStudentsList();
            updateAbsenceStudentSelect();
        }
        function deleteStudent(id){
            if(!isHost)return;
            event.stopPropagation();
            if(confirm("Supprimer cet √©l√®ve? Toutes ses absences seront √©galement effac√©es.")){
                studentsData = studentsData.filter(s=>s.id!==id);
                absencesData = absencesData.filter(a=>a.studentId!==id);
                saveStudentsData();
                renderStudentsList();
                updateAbsenceStudentSelect();
            }
        }
        function saveStudentsData(){
            localStorage.setItem('studentsData',JSON.stringify(studentsData));
            localStorage.setItem('absencesData',JSON.stringify(absencesData));
        }
        function renderStudentsList(){
            const container = document.getElementById('students-list-container');
            container.innerHTML = '';
            if(studentsData.length===0){container.innerHTML='<p style="text-align:center;color:#888;">Aucun √©l√®ve enregistr√©.</p>';return;}
            studentsData.forEach(student=>{
                const div = document.createElement('div');
                div.innerHTML = `<span>${student.firstName} <strong>${student.lastName}</strong></span><span class="delete-student-btn" onclick="deleteStudent(${student.id})">√ó</span>`;
                div.onclick = ()=>viewAbsences(student.id);
                container.appendChild(div);
            });
        }
        function recordAbsence(){
            if(!isHost)return;
            const courseId = parseInt(document.getElementById('course-id').value);
            const studentId = parseInt(document.getElementById('absence-student-select').value);
            const dateStr = document.getElementById('absence-date-input').value;
            const reason = document.getElementById('absence-reason-input').value.trim();
            if(!courseId)return alert("Veuillez d'abord s√©lectionner ou cr√©er un cours.");
            if(!studentId)return alert("Veuillez s√©lectionner un √©l√®ve.");
            if(!dateStr)return alert("Veuillez s√©lectionner une date.");
            const course = scheduleData.find(c=>c.id===courseId);
            if(!course)return alert("Cours introuvable.");
            const newAbsence = {id:Date.now(),studentId:studentId,courseId:courseId,courseName:course.name,date:dateStr,reason:reason||'Non sp√©cifi√©e',start:course.start,end:course.start+course.duration};
            absencesData.push(newAbsence);
            saveStudentsData();
            alert(`Absence enregistr√©e pour ${studentsData.find(s=>s.id===studentId).firstName} en ${course.name} le ${dateStr}.`);
            document.getElementById('absence-student-select').value = '';
            document.getElementById('absence-reason-input').value = '';
            document.getElementById('absence-date-input').valueAsDate = new Date();
        }
        function viewAbsences(studentId){
            const student = studentsData.find(s=>s.id===studentId);
            if(!student)return;
            const studentAbsences = absencesData.filter(a=>a.studentId===studentId).sort((a,b)=>new Date(b.date)-new Date(a.date));
            document.getElementById('absences-viewer-title').innerText = `Absences de ${student.firstName} ${student.lastName}`;
            const listContainer = document.getElementById('absences-list');
            listContainer.innerHTML = '';
            if(studentAbsences.length===0){listContainer.innerHTML='<p style="text-align:center;color:#888;">Cet √©l√®ve n\'a aucune absence enregistr√©e.</p>';}else{let html='<table><tr><th>Date</th><th>Cours</th><th>Heure</th><th>Raison</th><th>Action</th></tr>';studentAbsences.forEach(abs=>{html+=`<tr><td>${abs.date}</td><td>${abs.courseName}</td><td>${formatTime(abs.start)} - ${formatTime(abs.end)}</td><td>${abs.reason}</td><td><button onclick="deleteAbsence(${abs.id})" style="background:red;color:white;padding:5px;font-size:0.8em;">Suppr.</button></td></tr>`;});html+='</table>';listContainer.innerHTML=html;}
            document.getElementById('absences-viewer-modal').style.display = 'flex';
        }
        function deleteAbsence(absenceId){
            if(!isHost||!confirm("Voulez-vous vraiment supprimer cette absence?"))return;
            absencesData = absencesData.filter(a=>a.id!==absenceId);
            saveStudentsData();
            const studentId = absencesData.find(a=>a.id===absenceId)?.studentId||parseInt(document.getElementById('absences-viewer-modal').querySelector('h3').innerText.match(/\d+/)||0);
            viewAbsences(studentId);
        }
        function saveCourse(){
            const id = document.getElementById('course-id').value;
            const name = document.getElementById('course-name').value;
            const room = document.getElementById('course-room').value;
            const day = parseInt(document.getElementById('course-day').value);
            const startTimeStr = document.getElementById('course-start-time').value;
            const endTimeStr = document.getElementById('course-end-time').value;
            const start = timeStrToDecimal(startTimeStr);
            const end = timeStrToDecimal(endTimeStr);
            const color = document.getElementById('course-color').value;
            if(!name)return alert("Nom du cours requis!");
            if(end<=start)return alert("L'heure de fin doit √™tre strictement apr√®s l'heure de d√©but.");
            if(start<8||end>24)return alert("Heure invalide. L'emploi du temps couvre 08h00 √† 20h00 (d√©but) et 24h00 (fin max).");
            const duration = end-start;
            const newCourseData = {id:id?parseInt(id):Date.now(),day,start,duration,name,room,color};
            if(id){scheduleData=scheduleData.map(c=>c.id===newCourseData.id?newCourseData:c);}else{scheduleData.push(newCourseData);}
            save();
            closeModal('editor-modal');
        }
        function openEditor(id=null){
            if(!isHost)return;
            const modalTitle = document.getElementById('editor-title');
            const actionBtn = document.getElementById('editor-action-btn');
            document.getElementById('course-id').value = '';
            document.getElementById('course-name').value = '';
            document.getElementById('course-room').value = 'G111';
            document.getElementById('course-day').value = 0;
            document.getElementById('course-start-time').value = '08:00';
            document.getElementById('course-end-time').value = '09:00';
            document.getElementById('course-color').value = 'c-jaune';
            updateAbsenceStudentSelect();
            document.getElementById('absence-student-select').value = '';
            document.getElementById('absence-reason-input').value = '';
            document.getElementById('absence-date-input').valueAsDate = new Date();
            if(id){
                const course = scheduleData.find(c=>c.id===id);
                if(course){
                    modalTitle.innerText = "Modifier Cours";
                    actionBtn.innerText = "Sauvegarder les modifications";
                    const endTime = course.start+course.duration;
                    document.getElementById('course-id').value = course.id;
                    document.getElementById('course-name').value = course.name;
                    document.getElementById('course-room').value = course.room;
                    document.getElementById('course-day').value = course.day;
                    document.getElementById('course-start-time').value = decimalToTimeStr(course.start);
                    document.getElementById('course-end-time').value = decimalToTimeStr(endTime);
                    document.getElementById('course-color').value = course.color;
                }
            } else {
                modalTitle.innerText = "Nouveau Cours";
                actionBtn.innerText = "Ajouter";
            }
            document.getElementById('editor-modal').style.display = 'flex';
        }
        function resetData(){if(confirm("Tout effacer et remettre l'emploi du temps, les √©l√®ves ET les absences par d√©faut?")){scheduleData=[...courses];studentsData=[];absencesData=[];save();}}
        function closeModal(id){document.getElementById(id).style.display='none';}
        function updateTimeLine(){
            const now = new Date();
            const h = now.getHours();
            const m = now.getMinutes();
            const badge = document.getElementById('time-badge');
            const line = document.getElementById('current-time-line');
            badge.textContent = `${h}:${m<10?'0'+m:m}`;
            if(h>=8 && h<20){
                line.style.display = 'block';
                const topPos = ((h-8)*70)+(m*(70/60))+54;
                line.style.top = topPos+'px';
            }else{line.style.display='none';}
        }
    </script>
</body>
</html>
